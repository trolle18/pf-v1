!function(a){var i={anyProcess:{type:"",active:!1,timer:""},jobFinished:!1,getLogs:!1};function o(){var e={action:"onestg_get_staging",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,o){console.log(e.status+" "+e.statusText+"---"+t),a("#onme_errors").html("").html("Failed to get staging details, please reload the page and try again.")},success:function(e){a(document).find("#staging_entry").slideUp().remove(),a("#staging-create").slideUp("fast").before(e),a(".one-staging-msg").removeClass("hide"),window.location.reload()},statusCode:{200:function(){},404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}function t(){var e={action:"onestg_scanning",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,o){console.log(e.status+" "+e.statusText+"---"+t),f()},success:function(e){var t;!0!==e.error?(a("#dir_list").html("").html(e),a("#dir_list").length&&a("#dir_list").find(".wpstg-expand-dirs").bind("click",function(e){e.preventDefault(),a(this).hasClass("disabled")||a(this).siblings(".wpstg-subdir").slideToggle()}),t={action:"onestg_check_disk_space",nonce:wpstg.nonce},a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:t,error:function(e,t,o){console.log(e.status+" "+e.statusText+"---"+t),f()},success:function(e){!0!==e.error?!1!==e?(function(){w(wpstg.msgPrep,0,0);var e=wpstg.stgID,t=wpstg.stgPrefix,o=c(),n=l(),r=g(),s=d();data={action:"onestg_cloning",nonce:wpstg.nonce,cloneID:e,stgPrefix:t,excludedTables:o,includedDirectories:n,excludedDirectories:r,extraDirectories:s},a.ajax({url:ajaxurl,type:"POST",data:data,error:function(e,t,o){console.log(e.status+" "+e.statusText),f()},success:function(e){void 0===e.error||void 0===e.message?(w(wpstg.msgPrep,100,0),u()):f(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}(),a("#av_space").html("Available free disk space "+e.freespace+" <br> Estimated necessary disk space: "+e.usedspace).show()):a("#onme_errors").text("Can not detect disk space.").show():f(e.message)},statusCode:{200:function(){},404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})):f(e.message)},statusCode:{200:function(){},404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}function n(){var e=a("#console_log");void 0!==e[0]&&e.scrollTop(e[0].scrollHeight)}function r(e){null!=e&&void 0!==e&&e.constructor===Array&&a.each(e,function(e,t){null!==t&&t.type}),n()}function c(){var e=[];return a(".onestaging-db-table input:not(:checked)").each(function(){e.push(this.name)}),e}function l(){var t=[];return a(".wpstg-dir input:checked").each(function(){var e=a(this);e.parent(".wpstg-dir").parents(".wpstg-dir").children(".wpstg-expand-dirs").hasClass("disabled")||t.push(e.val())}),t}function g(){var t=[];return a(".wpstg-dir input:not(:checked)").each(function(){var e=a(this);e.parent(".wpstg-dir").parents(".wpstg-dir").children(".wpstg-expand-dirs").hasClass("disabled")||t.push(e.val())}),t}function d(){var e=[];if(!a("#wpstg_extraDirectories").val())return e;e=a("#wpstg_extraDirectories").val().split(/\r?\n/);return console.log(e),e}function u(){w(wpstg.msgNewStg,0,0),setTimeout(function(){w(wpstg.msgCopyDB,0,0),function t(){!0===i.getLogs&&r();setTimeout(function(){var e={action:"onestg_clone_database",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){console.log(e.status+" "+e.statusText),f()},success:function(e){void 0===e.error||void 0===e.message?(w(wpstg.msgCopyDB,e.percentage,0),void 0!==e.last_msg&&r(e.last_msg),!1===e.status?setTimeout(function(){t()},wpstg.cpuLoad):!0===e.status&&setTimeout(function(){w(wpstg.msgPrepDirs,0,0),s()},wpstg.cpuLoad)):f(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})},500)}()},wpstg.cpuLoad)}function s(){!0!==i.jobFinished&&(!0===i.getLogs&&r(),a("#clone_log").append("Creating Directory Tree...<hr>"),setTimeout(function(){var e={action:"onestg_clone_prepare_directories",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,o){f()},success:function(e){void 0===e.error||void 0===e.message?(w(wpstg.msgPrepDirs,e.percentage,0),void 0!==e.last_msg&&r(e.last_msg),!1===e.status?setTimeout(function(){s()},wpstg.cpuLoad):!0===e.status&&(w(wpstg.msgCopyFiles,0,0),function t(){if(!0===i.jobFinished)return!1;!0===i.getLogs&&r();var e={action:"onestg_clone_files",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){f()},success:function(e){void 0===e.error||void 0===e.message?(void 0!==e.percentage&&w(wpstg.msgCopyFiles,e.percentage,0),void 0!==e.last_msg&&r(e.last_msg),!1===e.status?setTimeout(function(){t()},wpstg.cpuLoad):!0===e.status&&setTimeout(function(){m()},wpstg.cpuLoad)):f(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}())):f(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})},500))}function m(){var e;!0!==i.jobFinished&&(!0===i.getLogs&&r(),e={action:"onestg_clone_replace_data",nonce:wpstg.nonce},w(wpstg.msgUpdateDB,0,0),a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){f()},success:function(e){void 0===e.error||void 0===e.message?(w(wpstg.msgUpdateDB,e.percentage,0),void 0!==e.last_msg&&r(e.last_msg),!1===e.status?setTimeout(function(){m()},wpstg.cpuLoad):!0===e.status&&function t(e){if(!0===i.jobFinished)return h(e),!1;w(wpstg.msgFinalize,0,0);var e=((new Date).getTime()-i.anyProcess.timer).toFixed(0);e=(e/1e3).toFixed(2);e={action:"onestg_clone_finish",nonce:wpstg.nonce,totalTime:e};a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:e,error:function(e,t,o){f(),i.anyProcess.timer=""},success:function(e){if("object"!=typeof e)return console.log("Couldn't finish the cloning process properly. Your snapshot has been copied but failed to do clean up and saving its records to the database."),void(i.anyProcess.timer="");i.anyProcess.type="",i.anyProcess.active=!1,i.anyProcess.timer="",window.onbeforeunload="",o(),a(".onecom-notifier").html(wpstg.copy_msg).attr("type","success").addClass("show"),setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click")},3e3),void 0!==e.last_msg&&r(e.last_msg),w(wpstg.msgFinished,100,1),n(),i.jobFinished=!0,t(e)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}()):f(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}}))}function h(e){a("#clone_area_head").find(".spinner").removeClass("is-active"),"undefined"!=e&&"undefined"!=e.url&&a("#onme_errors").html("Staging site created : "+e.url+"/wp-admin/").addClass("green").slideDown(),a(".stopwatch._clone").addClass("done")}function p(){if(!0===i.anyProcess.active)switch(i.anyProcess.type){case"stg":return"Staging creation will get interrupted if you leave or reload this page.";case"live":return"Copy staging to live will get interrupted if you leave or reload this page.";case"delete":return"Staging will not get deleted properly if you leave or reload this page.";case"update":return"Staging updation will get interrupted if you leave or reload this page.";default:return"Please do not leave the page. The current process will get interrupted."}return!0}function f(e){var t=wpstg.error_msg;void 0!==e&&e.length&&(t=e),a(".onecom-notifier").html(t).attr("type","error").addClass("show"),setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click")},5e3),e=i.anyProcess.type,t=t,e.length&&(t={action:"onestg_clone_log_error",nonce:wpstg.nonce,stg_action:e,msg:t},a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:t,error:function(e,t,o){console.log("Could not log the error"),i.anyProcess.type="",i.anyProcess.active=!1,window.onbeforeunload=""},success:function(e){i.anyProcess.type="",i.anyProcess.active=!1,window.onbeforeunload=""}}))}function w(e,t,o){e.length&&(a(".loading-overlay.show").find(".onecom_progress_bar").length?(a(".loading-overlay.show .onecom_progress_bar .job").html(e),0==t?a(".loading-overlay.show .onecom_progress_bar span").hide().width(t+"%").show():a(".loading-overlay.show .onecom_progress_bar span").width(t+"%")):(t='<div class="onecom_progress_bar" style="display: none;"><div class="job">'+e+'</div><span style="width:'+t+'%"></span></div>',a(".loading-overlay.show").find(".loader").before(t),a(".loading-overlay.show").find(".onecom_progress_bar").slideDown("fast")),o.length&&1===o&&a(".loading-overlay.show").find(".onecom_progress_bar").slideUp("fast"))}window.onbeforeunload="",a(".one-button-create-staging").on("click",function(){i.anyProcess.type="staging_create",i.anyProcess.active=!0,i.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=p,a(".loading-overlay.fullscreen-loader").not(".new-staging").addClass("show forced-center"),oc_validate_action("stg").then(function(e){"success"===e.status?(a(".loading-overlay.new-staging").addClass("show"),t(),oc_trigger_log({actionType:"wppremium_click_feature",isPremium:"true",feature:"STAGING_ENV",featureAction:"create"})):"failed"===e.status?(jQuery("#oc_um_overlay").show(),ocSetModalData({isPremium:"true",feature:"STAGING_ENV",featureAction:"create"})):e.msg&&oc_alert(e.msg,"error",5e3),a(".loading-overlay.fullscreen-loader").not(".new-staging").removeClass("show forced-center")})}),a(".one-button-update-staging").click(function(){var e=a(this).attr("data-width"),t=a(this).attr("data-height"),o=a(this).attr("data-dialog-id"),n=a(this).attr("data-title");tb_show(n,"#TB_inline?width="+e+"&height="+t+"&inlineId="+o+"&modal=true&class=thickbox",null),a("#TB_window").css({"margin-left":"-"+parseInt(e/2,10)+"px",top:"50%","margin-top":"-"+parseInt(t/2,10)+"px"})}),a(".one-button-update-staging-confirm").click(function(){oc_validate_action("stg").then(function(e){var t,o,n,r,s;"success"===e.status?(a(".loading-overlay.update-loader").addClass("show"),a(".one-dialog-close").trigger("click"),(s=a(".one-staging-entry").data("staging-id"))?(i.anyProcess.type="staging_rebuild",i.anyProcess.active=!0,i.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=p,(t=s)&&(o=t,n=c(),r=l(),s=g(),t=d(),data={action:"onestg_update",nonce:wpstg.nonce,cloneID:o,excludedTables:n,includedDirectories:r,excludedDirectories:s,extraDirectories:t},console.log("Preparing for UPDATING cloning..."),a.ajax({url:ajaxurl,type:"POST",data:data,error:function(e,t,o){f()},success:function(e){void 0===e.error||void 0===e.message?u():f(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})),oc_trigger_log({actionType:"wppremium_click_feature",isPremium:"true",feature:"STAGING_ENV",featureAction:"rebuild"})):(a(".onecom-notifier").html("Error: Staging data not found.").attr("type","error").addClass("show"),setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click")},5e3))):"failed"===e.status?(a(".one-dialog-close").trigger("click"),jQuery("#oc_um_overlay").show(),ocSetModalData({isPremium:"true",feature:"STAGING_ENV",featureAction:"rebuild"})):e.msg&&(a(".one-dialog-close").trigger("click"),oc_alert(e.msg,"error",5e3)),a(".loading-overlay.fullscreen-loader").not(".update-loader").removeClass("show forced-center")})}),a(".one-button-update-staging-cancel").click(function(){a(this).parents().find(".one-dialog-close").trigger("click")}),a(".one-button-delete-staging").click(function(){var e=a(this).attr("data-width"),t=a(this).attr("data-height"),o=a(this).attr("data-dialog-id"),n=a(this).attr("data-title");tb_show(n,"#TB_inline?width="+e+"&height="+t+"&inlineId="+o+"&modal=true&class=thickbox",null),a("#TB_window").css({height:"250px","margin-left":"-"+parseInt(e/2,10)+"px",top:"50%","margin-top":"-"+parseInt(t/2,10)+"px"})}),a(".one-button-delete-staging-confirm").click(function(){a(".loading-overlay.delete-loader").first().addClass("show");var e=a(".one-staging-entry").data("staging-id");e?(a(".one-dialog-close").trigger("click"),i.anyProcess.type="staging_delete",i.anyProcess.active=!0,i.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=p,function t(o){var e=((e=((new Date).getTime()-i.anyProcess.timer).toFixed(2))/1e3).toFixed(2);data={action:"onestg_delete_clone",clone:o,nonce:wpstg.nonce,excludedTables:c(),deleteDir:a("#deleteDirectory:checked").val(),totalTime:e},w(wpstg.msgDelStg,0,0),a.ajax({url:ajaxurl,type:"POST",dataType:"JSON",data:data,error:function(e,t,o){a("#onme_errors").text("Some error occurred").show(),f(data.message)},success:function(e){if(e){if(void 0!==e.error&&void 0!==e.message)return void f(e.message);if(void 0!==e.delete&&"finished"===e.delete)return w(wpstg.msgDelStg,100,1),a("#entry_"+o).fadeIn(5e3,function(){a(this).remove()}),i.anyProcess.type="",i.anyProcess.active=!1,window.onbeforeunload="",window.location.reload(),a(".onecom-notifier").html("Staging website has been removed.").attr("type","success").addClass("show"),void setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click"),a(".one-staging-details").hide(),a(".one-staging-actions").hide(),a("#staging-create").slideDown(),a(".one-card-staging-create").fadeIn(300)},7e3)}!0!==e&&t(o)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}})}(e)):(a(".onecom-notifier").html("Error: Staging data not found.").attr("type","error").addClass("show"),setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click")},5e3))}),a(".one-button-copy-to-live").click(function(){var e=a(this).attr("data-width"),t=a(this).attr("data-height"),o=a(this).attr("data-dialog-id"),n=a(this).attr("data-title");tb_show(n,"#TB_inline?width="+e+"&height="+t+"&inlineId="+o+"&modal=true&class=thickbox",null),a("#TB_window").css({height:"275px","margin-left":"-"+parseInt(e/2,10)+"px",top:"50%","margin-top":"-"+parseInt(t/2,10)+"px"})}),a(".one-button-copy-to-live-cancel, .one-button-delete-staging-cancel").click(function(){a(".one-dialog-close").trigger("click")}),a("#one-button-copy-to-live-confirm").on("click",function(){a(".loading-overlay.deploy-loader").addClass("show"),a(".one-dialog-close").trigger("click");var e,t,o,n,r=a("#deploy_to_live").data("live-id");console.log("Starting deployment Staging-to-Live : "+r),i.anyProcess.type="staging_deploy",i.anyProcess.active=!0,i.anyProcess.timer=(new Date).getTime(),window.onbeforeunload=p,(e=r)&&(t=e,o=c(),n=l(),r=g(),e=d(),console.log(n),data={action:"onestg_deploy",nonce:wpstg.nonce,liveDirectory:t,excludedTables:o,includedDirectories:n,excludedDirectories:r,extraDirectories:e},a.ajax({url:ajaxurl,type:"POST",data:data,error:function(e,t,o){console.log(e.status+" "+e.statusText),f()},success:function(e){void 0===e.error||void 0===e.message?u():f(e.message)},statusCode:{404:function(){a("#onme_errors").html("").html("Something went wrong; can't find ajax request URL!")},500:function(){a("#onme_errors").html("").html("Something went wrong; internal server error while processing the request!")}}}))}),a(".loginStaging").click(function(){var e={action:"onestg_log_attempt",nonce:wpstg.nonce};a.ajax({url:ajaxurl,type:"POST",data:e,error:function(e,t,o){},success:function(e){var t;if("object"==typeof e)return!1===e.success?(a(".onecom-notifier").html("Unable to do login into staging").attr("type","error").addClass("show"),void setTimeout(function(){a(".onecom-notifier").removeClass("show"),a(".one-dialog-close").trigger("click")},5e3)):void(!0===e.success&&(t=e.data.timelog,e=e.data.stgUrl,window.open(e+"/wp-admin/?timelog="+t+"&stgUrl="+e,"_blank")))}})})}(jQuery);